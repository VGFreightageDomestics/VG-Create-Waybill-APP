<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VG Mobile App</title>
    
    <meta name="theme-color" content="#001f60">
    <meta name="apple-mobile-web-app-capable" content="yes">
    
    <!-- CSS & Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
    
    <style>
        body { background-color: #f0f2f5; font-family: 'Montserrat', sans-serif; user-select: none; padding-bottom: 80px; }
        
        /* HEADER */
        .mobile-header {
            background: #001f60; color: white; padding: 15px; position: sticky; top: 0; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .header-title { font-family: 'Oswald', sans-serif; letter-spacing: 1px; font-size: 1.2rem; }

        /* CARDS */
        .app-card { background: white; border-radius: 12px; padding: 20px; margin: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .form-label { font-size: 0.75rem; font-weight: 700; color: #666; text-transform: uppercase; margin-bottom: 5px; }
        .form-control, .form-select { border-radius: 8px; padding: 12px; font-weight: 600; border: 1px solid #dee2e6; }
        .form-control:focus { border-color: #001f60; box-shadow: none; }
        
        /* NAVIGATION */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; background: white; height: 65px;
            display: flex; justify-content: space-around; align-items: center;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1000; border-top: 1px solid #eee;
        }
        .nav-item { text-align: center; color: #9ca3af; flex: 1; cursor: pointer; padding: 5px; }
        .nav-item.active { color: #001f60; background: #f8f9fa; border-top: 3px solid #001f60; }
        .nav-icon { font-size: 1.4rem; margin-bottom: 2px; }
        .nav-text { font-size: 0.65rem; font-weight: 700; }

        /* MODAL (PRINT POPUP) */
        .custom-modal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85);
            z-index: 2000; display: flex; justify-content: center; align-items: center;
        }
        .modal-box { background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 350px; text-align: center; }

        /* UTILS */
        .hidden { display: none !important; }
        .btn-xl { width: 100%; padding: 15px; font-weight: 800; border-radius: 10px; font-size: 1.1rem; }

        /* --- FIXED PRINT STYLES (A6) --- */
        #printArea { display: none; } 

        @media print {
            body * { visibility: hidden; } 
            
            #printArea, #printArea * { 
                visibility: visible !important; 
            }
            
            #printArea { 
                display: block !important; 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                margin: 0;
                padding: 0;
            }
            
            @page { size: 100mm 150mm; margin: 0; }
            
            .sticker-page { 
                width: 100mm; height: 149mm; margin: 0 auto; 
                border: 3px solid black; background: white; color: black;
                font-family: 'Arial', sans-serif; display: flex; flex-direction: column;
                box-sizing: border-box; padding: 0; overflow: hidden;
                page-break-after: always; break-after: always;
            }
            .sticker-page:last-child { page-break-after: auto; }

            /* Header */
            .wb-header { display: flex; justify-content: space-between; align-items: center; padding: 5px; border-bottom: 2px solid black; background: #eee; -webkit-print-color-adjust: exact; }
            .wb-logo { height: 18px; } .wb-title { font-family: 'Oswald', sans-serif; font-weight: bold; font-size: 14px; }
            
            /* Destination (Big Black Box) */
            .wb-dest { background: black; color: white; text-align: center; font-family: 'Oswald', sans-serif; font-size: 45px; font-weight: 900; line-height: 1; padding: 5px 0; -webkit-print-color-adjust: exact; }
            
            /* Warning */
            .wb-warn { text-align: center; font-size: 24px; font-weight: 900; border-bottom: 2px solid black; text-transform: uppercase; display: none; padding: 2px 0; }
            .wb-warn.show { display: block; }

            /* QR & Waybill */
            .wb-qr-box { display: flex; justify-content: space-between; align-items: center; padding: 5px 10px; border-bottom: 2px solid black; }
            .wb-num { font-size: 28px; font-weight: 900; font-family: 'Oswald', sans-serif; letter-spacing: 1px; }
            
            /* Details */
            .wb-info { padding: 8px; border-bottom: 1px solid black; font-size: 12px; line-height: 1.3; }
            
            /* Footer (Fixed Overlapping) */
            .wb-foot { 
                display: flex; border-top: 3px solid black; height: 60px; margin-top: auto; 
            }
            .wb-cell { 
                flex: 1; border-right: 2px solid black; text-align: center; 
                display: flex; flex-direction: column; justify-content: center; align-items: center;
            }
            .wb-cell:last-child { border: none; }
            
            .wb-lbl { font-size: 10px; font-weight: bold; text-transform: uppercase; margin-bottom: 2px; }
            .wb-val { font-size: 22px; font-weight: 900; line-height: 1; }
        }
    </style>
</head>
<body>

    <!-- 1. LOGIN -->
    <div id="viewLogin" style="height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: #001f60; color: white; padding: 30px; position: fixed; width: 100%; top:0; z-index: 3000;">
        <i class="fas fa-cubes fa-4x mb-3 text-warning"></i>
        <h3 class="fw-bold mb-4">VG MOBILE</h3>
        <input type="email" id="email" class="form-control mb-3 text-center" placeholder="Email Address">
        <input type="password" id="pass" class="form-control mb-4 text-center" placeholder="Password">
        <button class="btn btn-warning w-100 py-3 fw-bold rounded-3" onclick="login()">LOGIN</button>
    </div>

    <!-- 2. MAIN APP -->
    <div id="viewMain" class="hidden">
        
        <div class="mobile-header">
            <div class="header-title"><i class="fas fa-shipping-fast text-warning me-2"></i> VG FREIGHTAGE</div>
            <button class="btn btn-sm btn-outline-light" onclick="logout()"><i class="fas fa-sign-out-alt"></i></button>
        </div>

        <!-- CREATE TAB -->
        <div id="tab-create" class="tab-pane">
            <div class="app-card">
                <h5 class="fw-bold text-primary mb-3">Create Waybill</h5>
                
                <div class="input-group mb-3">
                    <input type="text" id="wbInput" class="form-control fw-bold text-center text-primary fs-5">
                    <button class="btn btn-secondary" onclick="generateRandomWB()">AUTO</button>
                </div>

                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <label class="form-label">Origin</label>
                        <input type="text" id="shipperAddr" class="form-control" placeholder="MNL HUB">
                    </div>
                    <div class="col-6">
                        <label class="form-label">Destination</label>
                        <input type="text" id="consigneeAddr" class="form-control" placeholder="DVO HUB">
                    </div>
                </div>

                <input type="hidden" id="shipperName" value="Mobile Sender"><input type="hidden" id="shipperContact" value="0">
                <input type="hidden" id="consigneeName" value="Mobile Receiver"><input type="hidden" id="consigneeContact" value="0">

                <div class="row g-2 mb-3">
                    <div class="col-4"><label class="form-label">Qty</label><input type="number" id="qty" class="form-control text-center" value="1"></div>
                    <div class="col-4"><label class="form-label">Wt (kg)</label><input type="text" id="weight" class="form-control text-center" placeholder="0"></div>
                    <div class="col-4">
                        <label class="form-label">Type</label>
                        <select id="handling" class="form-select" style="font-size:0.8rem; padding: 12px 5px;">
                            <option value="Standard">Std</option>
                            <option value="FRAGILE">Fragile</option>
                            <option value="PERISHABLE">Perish</option>
                        </select>
                    </div>
                </div>

                <button class="btn btn-success btn-xl mt-2" onclick="createParcel()">
                    <i class="fas fa-save me-2"></i> SAVE & PRINT
                </button>
            </div>
        </div>

        <!-- SCAN TAB -->
        <div id="tab-scan" class="tab-pane hidden">
            <div class="app-card">
                <h5 class="fw-bold text-primary mb-3">Scan QR</h5>
                <div id="reader" style="background:black; min-height:250px;"></div>
                <div id="scanForm" class="hidden">
                    <div class="alert alert-info text-center py-2 mb-2"><strong><i class="fas fa-qrcode"></i> <span id="detectedWB">...</span></strong></div>
                    <label class="form-label">Status</label>
                    <select id="newStatus" class="form-select mb-2 fw-bold">
                        <option value="" disabled selected>Select...</option>
                        <option>Picked Up</option><option>Departed Origin</option><option>In Transit</option><option>Arrived at Hub</option><option>Out for Delivery</option><option>Delivered</option>
                    </select>
                    <label class="form-label">Location</label>
                    <select id="currentLocSelect" class="form-select mb-2"><option disabled selected>Loading...</option></select>
                    <button class="btn btn-primary btn-xl mt-2" onclick="updateStatus()">UPDATE STATUS</button>
                    <button class="btn btn-secondary w-100 mt-2 btn-sm" onclick="resetScan()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- TRACK TAB -->
        <div id="tab-track" class="tab-pane hidden">
            <div class="app-card">
                <h5 class="fw-bold text-primary mb-3">Track / Reprint</h5>
                <div class="input-group mb-3">
                    <input type="text" id="trackInput" class="form-control" placeholder="Waybill #">
                    <button class="btn btn-primary" onclick="trackItem()"><i class="fas fa-search"></i></button>
                </div>
                <div id="trackResult"></div>
                <!-- Reprint Box -->
                <div id="reprintBox" class="hidden mt-3 pt-3 border-top">
                    <label class="form-label">Print Selection</label>
                    <div class="d-flex align-items-center gap-2 mb-2">
                        <input type="number" id="rpStart" class="form-control text-center" value="1">
                        <span>to</span>
                        <input type="number" id="rpEnd" class="form-control text-center" value="1">
                    </div>
                    <button class="btn btn-dark w-100 fw-bold" onclick="reprintRange()">PRINT STICKERS</button>
                </div>
            </div>
        </div>

        <!-- ADMIN TAB -->
        <div id="tab-admin" class="tab-pane hidden">
            <div class="app-card">
                <h5 class="fw-bold text-danger">Admin Tools</h5>
                <button class="btn btn-outline-danger w-100 mb-2" onclick="exportToExcel()">Download CSV Report</button>
                <div class="alert alert-warning small">Use PC for full admin controls.</div>
            </div>
        </div>

        <!-- NAV -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('create')"><div class="nav-icon"><i class="fas fa-plus-square"></i></div><div class="nav-text">CREATE</div></div>
            <div class="nav-item" onclick="switchTab('scan')"><div class="nav-icon"><i class="fas fa-qrcode"></i></div><div class="nav-text">SCAN</div></div>
            <div class="nav-item" onclick="switchTab('track')"><div class="nav-icon"><i class="fas fa-search"></i></div><div class="nav-text">TRACK</div></div>
            <div class="nav-item" onclick="switchTab('admin')"><div class="nav-icon"><i class="fas fa-user-shield"></i></div><div class="nav-text">ADMIN</div></div>
        </div>
    </div>

    <!-- PRINT MODAL -->
    <div id="printModal" class="custom-modal hidden">
        <div class="modal-box">
            <i class="fas fa-check-circle text-success fa-3x mb-3"></i>
            <h4 class="fw-bold">SAVED!</h4>
            <p class="mb-3">Waybill: <b id="pmWb">...</b></p>
            <div class="bg-light p-3 rounded mb-3 border">
                <label class="form-label d-block text-start">Copies to Print:</label>
                <div class="d-flex align-items-center gap-2">
                    <input type="number" id="pmStart" class="form-control text-center fw-bold" value="1">
                    <span>to</span>
                    <input type="number" id="pmEnd" class="form-control text-center fw-bold" value="1">
                </div>
            </div>
            <button class="btn btn-dark w-100 py-3 fw-bold" onclick="printFromCreate()">
                <i class="fas fa-print me-2"></i> PRINT NOW
            </button>
            <button class="btn btn-link text-muted mt-2" onclick="closePrintModal()">Close</button>
        </div>
    </div>

    <div id="printArea"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, setDoc, updateDoc, arrayUnion, onSnapshot, getDoc, collection, query, orderBy, getDocs } 
        from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        const firebaseConfig = {
            apiKey: "AIzaSyCrDEUr1O5krXFHEB2hafLXuEumEcoSTxM",
            authDomain: "vg-cargo-system-3.firebaseapp.com",
            projectId: "vg-cargo-system-3",
            storageBucket: "vg-cargo-system-3.firebasestorage.app",
            messagingSenderId: "819520192535",
            appId: "1:819520192535:web:8e42b272500f9b60e19c52"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        
        let html5QrcodeScanner = null;
        let currentCreatedData = null; // FIXED: Global variable for created data
        let currentTrackedData = null;

        window.login = async () => { try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pass').value); } catch(e){ alert(e.message); } }
        window.logout = () => signOut(auth);
        
        onAuthStateChanged(auth, user => {
            if(user) {
                document.getElementById('viewLogin').classList.add('hidden');
                document.getElementById('viewMain').classList.remove('hidden');
                generateRandomWB();
                loadLocations();
            } else {
                document.getElementById('viewLogin').classList.remove('hidden');
                document.getElementById('viewMain').classList.add('hidden');
            }
        });

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-pane').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-'+tab).classList.remove('hidden');
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            event.currentTarget.classList.add('active');
            if(tab === 'scan') startCamera(); else stopCamera();
        }

        window.generateRandomWB = () => { document.getElementById('wbInput').value = "VG-" + Math.floor(100000 + Math.random() * 900000); }

        window.createParcel = async () => {
            const wb = document.getElementById('wbInput').value;
            const org = document.getElementById('shipperAddr').value;
            const des = document.getElementById('consigneeAddr').value;
            const qty = document.getElementById('qty').value;
            const wt = document.getElementById('weight').value;
            const hdl = document.getElementById('handling').value;

            if(!org || !des) return alert("Fill Origin & Destination");

            try {
                const d = {
                    waybill: wb,
                    shipper: { name: "Mobile", addr: org, contact: "" },
                    consignee: { name: "Mobile", addr: des, contact: "" },
                    details: { qty: qty, weight: wt, handling: hdl },
                    currentStatus: "Accepted",
                    createdBy: auth.currentUser.email,
                    history: [{ status: "Accepted", location: "Origin", time: new Date().toLocaleString() }]
                };
                
                await setDoc(doc(db, "parcels", wb), d);
                
                // STORE DATA GLOBALLY FOR PRINTING
                currentCreatedData = d; 
                
                document.getElementById('pmWb').innerText = wb;
                document.getElementById('pmEnd').value = qty;
                document.getElementById('printModal').classList.remove('hidden');

            } catch(e) { alert(e.message); }
        }

        // FIXED: Dedicated function for printing from Create Modal
        window.printFromCreate = () => {
            const start = parseInt(document.getElementById('pmStart').value);
            const end = parseInt(document.getElementById('pmEnd').value);
            
            if(currentCreatedData) {
                generateStickers(currentCreatedData, start, end);
                setTimeout(() => window.print(), 800);
            } else {
                alert("Error: No data to print.");
            }
        }

        window.closePrintModal = () => {
            document.getElementById('printModal').classList.add('hidden');
            document.getElementById('shipperAddr').value = "";
            document.getElementById('consigneeAddr').value = "";
            document.getElementById('weight').value = "";
            generateRandomWB();
        }

        window.reprintRange = () => {
            if(!currentTrackedData) return;
            const start = parseInt(document.getElementById('rpStart').value);
            const end = parseInt(document.getElementById('rpEnd').value);
            generateStickers(currentTrackedData, start, end);
            setTimeout(() => window.print(), 800);
        }

        // UNIFIED STICKER GENERATOR (LAYOUT FIXED)
        function generateStickers(data, start, end) {
            const area = document.getElementById('printArea');
            area.innerHTML = "";
            
            let dCode = "DOM";
            const addr = data.consignee.addr.toUpperCase();
            if(addr.includes("DAVAO")) dCode="DVO";
            else if(addr.includes("MANILA") || addr.includes("MNL")) dCode="MNL";
            else if(addr.includes("CEBU")) dCode="CEB";
            else if(addr.includes("ILOILO")) dCode="ILO";
            else if(addr.includes("ROXAS")) dCode="ROX";
            else if(addr.includes("BACOLOD")) dCode="BCD";
            else if(addr.includes("GENSAN")) dCode="GES";
            else if(addr.includes("CAGAYAN")) dCode="CGY";

            const handling = data.details.handling || "Standard";
            const showWarning = (handling !== "Standard") ? "show" : "";

            for(let i=start; i<=end; i++) {
                const div = document.createElement('div');
                div.className = 'sticker-page';
                div.innerHTML = `
                    <div class="wb-header">
                        <img src="logo.png" class="wb-logo" onerror="this.style.display='none'">
                        <span class="wb-title">VG FREIGHTAGE DOMESTIC</span>
                    </div>
                    <div class="wb-dest">${dCode}</div>
                    <div class="wb-warn ${showWarning}">${handling}</div>
                    
                    <div class="wb-qr-box">
                        <div id="qr-${i}"></div>
                        <div class="wb-num">${data.waybill}</div>
                    </div>
                    
                    <div class="wb-info">
                        <strong>FROM:</strong> ${data.shipper.addr}
                    </div>
                    <div class="wb-info">
                        <strong>TO:</strong> ${data.consignee.addr}
                    </div>

                    <div class="wb-foot">
                        <div class="wb-cell">
                            <span class="wb-lbl">PCS</span>
                            <b class="wb-val">${i}/${data.details.qty}</b>
                        </div>
                        <div class="wb-cell">
                            <span class="wb-lbl">KG</span>
                            <b class="wb-val">${data.details.weight}</b>
                        </div>
                    </div>
                `;
                area.appendChild(div);
                new QRCode(document.getElementById(`qr-${i}`), { text: data.waybill, width: 140, height: 140 });
            }
        }

        // SCANNER
        function startCamera() {
            if(html5QrcodeScanner) html5QrcodeScanner.clear();
            html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250 });
            html5QrcodeScanner.render(onScanSuccess, ()=>{});
        }
        function stopCamera() { if(html5QrcodeScanner) html5QrcodeScanner.clear(); }
        
        function onScanSuccess(wb) {
            html5QrcodeScanner.clear();
            document.getElementById('reader').classList.add('hidden');
            document.getElementById('scanForm').classList.remove('hidden');
            document.getElementById('detectedWB').innerText = wb;
        }

        window.resetScan = () => {
            document.getElementById('scanForm').classList.add('hidden');
            document.getElementById('reader').classList.remove('hidden');
            startCamera();
        }

        function loadLocations() {
            onSnapshot(doc(db, "settings", "locations"), s => {
                let list = ["MNL HUB", "CEB HUB", "DVO HUB", "Rider", "Delivered"];
                if(s.exists() && s.data().list) list = s.data().list;
                list = [...new Set(list)].sort();
                let opts = list.map(l => `<option value="${l}">${l}</option>`).join('');
                document.getElementById('currentLocSelect').innerHTML = `<option disabled selected>Select...</option>` + opts;
            });
        }
        window.toggleCustomLoc = () => {
            const v = document.getElementById('currentLocSelect').value;
            if(v==='Other') document.getElementById('currentLocCustom').classList.remove('hidden');
            else document.getElementById('currentLocCustom').classList.add('hidden');
        }

        window.updateStatus = async () => {
            const wb = document.getElementById('detectedWB').innerText;
            const st = document.getElementById('newStatus').value;
            const lc = document.getElementById('currentLocSelect').value;

            if(!st || !lc) return alert("Select Status & Location");

            try {
                await updateDoc(doc(db, "parcels", wb), {
                    currentStatus: st,
                    history: arrayUnion({ status: st, location: lc, time: new Date().toLocaleString(), user: auth.currentUser.email })
                });
                alert("Updated!"); resetScan();
            } catch(e) { alert(e.message); }
        }

        // TRACKER
        window.trackItem = async () => {
            const wb = document.getElementById('trackInput').value.trim();
            const res = document.getElementById('trackResult');
            res.innerHTML = "Searching...";
            
            try {
                const s = await getDoc(doc(db, "parcels", wb));
                if(s.exists()) {
                    currentTrackedData = s.data();
                    res.innerHTML = `
                        <div class="alert alert-secondary mt-2">
                            <b>${currentTrackedData.waybill}</b><br>
                            ${currentTrackedData.currentStatus}
                        </div>
                    `;
                    document.getElementById('reprintBox').classList.remove('hidden');
                    document.getElementById('rpEnd').value = currentTrackedData.details.qty;
                } else {
                    res.innerHTML = "Not Found";
                    document.getElementById('reprintBox').classList.add('hidden');
                }
            } catch(e) { res.innerHTML = "Error"; }
        }

        window.exportToExcel = async () => {
            try {
                const q = query(collection(db, "parcels"), orderBy("waybill", "desc"));
                const querySnapshot = await getDocs(q);
                let csv = "Waybill,Status,Origin,Destination\n";
                querySnapshot.forEach(doc => {
                    const d = doc.data();
                    csv += `${d.waybill},${d.currentStatus},${d.shipper.addr},${d.consignee.addr}\n`;
                });
                const blob = new Blob([csv], { type: 'text/csv' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement("a"); a.href = url; a.download = "report.csv";
                document.body.appendChild(a); a.click();
            } catch(e) { alert(e.message); }
        }

        window.printFromCreate = printFromCreate;
        window.reprintRange = reprintRange;
        window.closePrintModal = closePrintModal;
        window.generateRandomWB = generateRandomWB;
        window.createParcel = createParcel;
        window.resetScan = resetScan;
        window.updateStatus = updateStatus;
        window.toggleCustomLoc = toggleCustomLoc;
        window.trackItem = trackItem;
        window.exportToExcel = exportToExcel;
    </script>
</body>
</html>
