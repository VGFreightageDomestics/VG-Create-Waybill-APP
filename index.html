<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>VG Mobile Ops</title>
    
    <!-- Mobile Settings -->
    <meta name="theme-color" content="#001f60">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    
    <!-- Libraries -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Oswald:wght@700&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
    
    <!-- Script Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        body { background-color: #f0f2f5; font-family: 'Roboto', sans-serif; user-select: none; padding-bottom: 80px; -webkit-tap-highlight-color: transparent; }
        
        /* --- HEADER --- */
        .app-header {
            background: #001f60; color: white; padding: 15px 20px;
            position: sticky; top: 0; z-index: 1000;
            display: flex; justify-content: space-between; align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .header-title { font-family: 'Oswald', sans-serif; letter-spacing: 1px; font-size: 1.2rem; }

        /* --- LOGIN --- */
        #viewLogin { height: 100vh; display: flex; flex-direction: column; justify-content: center; align-items: center; background: linear-gradient(135deg, #001f60, #000); color: white; padding: 30px; position: fixed; top: 0; width: 100%; z-index: 2000; }
        .login-input { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); color: white; border-radius: 10px; margin-bottom: 15px; text-align: center; }
        .login-input::placeholder { color: rgba(255,255,255,0.5); }
        .login-input:focus { background: rgba(255,255,255,0.2); color: white; border-color: white; box-shadow: none; }

        /* --- CARDS --- */
        .app-card { background: white; border-radius: 15px; padding: 20px; margin: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .form-label { font-size: 0.75rem; font-weight: 700; color: #6c757d; text-transform: uppercase; margin-bottom: 5px; }
        .form-control, .form-select { border-radius: 10px; padding: 12px; font-weight: 500; border: 1px solid #dee2e6; }
        .form-control:focus { border-color: #001f60; box-shadow: 0 0 0 3px rgba(0,31,96,0.1); }

        /* --- BOTTOM NAVIGATION --- */
        .bottom-nav {
            position: fixed; bottom: 0; width: 100%; background: white;
            display: flex; justify-content: space-around; padding: 10px 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05); z-index: 1000;
            border-top: 1px solid #eee;
        }
        .nav-item { text-align: center; color: #9ca3af; flex: 1; cursor: pointer; }
        .nav-item.active { color: #001f60; }
        .nav-icon { font-size: 1.4rem; margin-bottom: 2px; }
        .nav-text { font-size: 0.7rem; font-weight: bold; }

        /* --- SCANNER --- */
        #reader { width: 100%; border-radius: 15px; overflow: hidden; background: black; min-height: 300px; margin-bottom: 15px; }
        
        /* --- STICKER CANVAS (HIDDEN) --- */
        /* Design based on Airline Style (A6 Ratio) */
        #sticker-canvas {
            position: fixed; top: -9999px; left: 0;
            width: 384px; /* Standard Print Width for Mobile */
            background: white; color: black; border: 2px solid black;
            font-family: 'Oswald', sans-serif; display: flex; flex-direction: column;
        }
        .stk-head { background: #eee; border-bottom: 2px solid black; padding: 5px; display: flex; align-items: center; gap: 5px; }
        .stk-logo { height: 20px; }
        .stk-dest { background: black; color: white; font-size: 50px; font-weight: 900; text-align: center; line-height: 1; border-bottom: 2px solid black; padding: 5px 0; }
        .stk-warn { text-align: center; font-size: 20px; font-weight: bold; border-bottom: 2px solid black; padding: 2px; display: none; }
        .stk-body { padding: 10px; flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .stk-wb { font-size: 32px; font-weight: 900; border: 3px solid black; padding: 2px 10px; border-radius: 8px; margin-top: 10px; letter-spacing: 2px; }
        .stk-addr { width: 100%; border-top: 2px solid black; padding: 5px; font-family: Arial, sans-serif; font-size: 12px; }
        .stk-foot { display: flex; border-top: 2px solid black; }
        .stk-col { flex: 1; border-right: 2px solid black; text-align: center; padding: 5px; }
        .stk-col:last-child { border: none; }
        
        .hidden { display: none !important; }
        .btn-xl { width: 100%; padding: 15px; font-weight: 800; border-radius: 12px; font-size: 1.1rem; }
    </style>
</head>
<body>

    <!-- 1. LOGIN -->
    <div id="viewLogin">
        <i class="fas fa-shipping-fast fa-4x mb-3 text-warning"></i>
        <h3 class="fw-bold mb-4">VG STAFF APP</h3>
        <input type="email" id="email" class="form-control login-input" placeholder="Email Address">
        <input type="password" id="pass" class="form-control login-input" placeholder="Password">
        <button class="btn btn-warning w-100 py-3 fw-bold rounded-4" onclick="login()">SECURE LOGIN</button>
    </div>

    <!-- 2. MAIN APP -->
    <div id="viewMain" class="hidden">
        
        <div class="app-header">
            <div class="header-title"><i class="fas fa-box me-2 text-warning"></i> VG FREIGHTAGE</div>
            <button class="btn btn-sm btn-outline-light" onclick="logout()"><i class="fas fa-power-off"></i></button>
        </div>

        <!-- TAB: CREATE -->
        <div id="tab-create" class="tab-content">
            <div class="app-card">
                <h5 class="fw-bold text-primary mb-3">Create Waybill</h5>
                
                <!-- WAYBILL NO -->
                <div class="input-group mb-3">
                    <input type="text" id="wbInput" class="form-control fw-bold text-center text-primary fs-4" readonly>
                    <button class="btn btn-secondary" onclick="generateRandomWB()"><i class="fas fa-sync"></i></button>
                </div>

                <!-- ORIGIN / DESTINATION -->
                <div class="row g-2 mb-2">
                    <div class="col-6">
                        <label class="form-label">Origin</label>
                        <input type="text" id="shipperAddr" class="form-control fw-bold" placeholder="MNL HUB">
                    </div>
                    <div class="col-6">
                        <label class="form-label">Destination</label>
                        <input type="text" id="consigneeAddr" class="form-control fw-bold" placeholder="DVO HUB">
                    </div>
                </div>

                <!-- DETAILS -->
                <div class="row g-2 mb-2">
                    <div class="col-4">
                        <label class="form-label">Qty</label>
                        <input type="number" id="qty" class="form-control text-center" value="1">
                    </div>
                    <div class="col-4">
                        <label class="form-label">Weight</label>
                        <input type="text" id="weight" class="form-control text-center" placeholder="kg">
                    </div>
                    <div class="col-4">
                        <label class="form-label">Type</label>
                        <select id="handling" class="form-select" style="font-size:0.8rem; padding: 12px 5px;">
                            <option value="Standard">Std</option>
                            <option value="FRAGILE">Fragile</option>
                            <option value="PERISHABLE">Perish</option>
                        </select>
                    </div>
                </div>

                <!-- HIDDEN REQUIRED FIELDS -->
                <input type="hidden" id="shipperName" value="Mobile Sender">
                <input type="hidden" id="shipperContact" value="000">
                <input type="hidden" id="consigneeName" value="Mobile Receiver">
                <input type="hidden" id="consigneeContact" value="000">

                <button class="btn btn-success btn-xl mt-2" onclick="createParcel()">
                    <i class="fas fa-save me-2"></i> SAVE & PRINT
                </button>
            </div>
        </div>

        <!-- TAB: SCAN -->
        <div id="tab-scan" class="tab-content hidden">
            <div class="app-card">
                <h5 class="fw-bold text-primary mb-3">Scan & Update</h5>
                <div id="reader"></div>
                
                <div id="scanForm" class="hidden">
                    <div class="alert alert-info text-center py-2 mb-2">
                        <strong><i class="fas fa-qrcode"></i> <span id="detectedWB">...</span></strong>
                    </div>

                    <label class="form-label">Action / Location</label>
                    <select id="currentLocSelect" class="form-select mb-2 fw-bold" onchange="toggleCustomLoc()">
                        <option disabled selected>Loading...</option>
                    </select>
                    <input type="text" id="currentLocCustom" class="form-control mb-2 hidden" placeholder="Type Location">
                    
                    <button class="btn btn-primary btn-xl mt-2" onclick="updateStatus()">
                        UPDATE STATUS
                    </button>
                    <button class="btn btn-secondary w-100 mt-2 py-2 rounded-3" onclick="resetScan()">Cancel</button>
                </div>
            </div>
        </div>

        <!-- NAVIGATION BAR -->
        <div class="bottom-nav">
            <div class="nav-item active" onclick="switchTab('create')">
                <div class="nav-icon"><i class="fas fa-plus-square"></i></div>
                <div class="nav-text">CREATE</div>
            </div>
            <div class="nav-item" onclick="switchTab('scan')">
                <div class="nav-icon"><i class="fas fa-qrcode"></i></div>
                <div class="nav-text">SCAN</div>
            </div>
        </div>

    </div>

    <!-- HIDDEN STICKER GENERATOR -->
    <div id="sticker-canvas">
        <div class="stk-head">
            <img src="logo.png" class="stk-logo" onerror="this.style.display='none'">
            <span style="font-size:12px; font-weight:bold;">VG FREIGHTAGE</span>
        </div>
        <div class="stk-dest" id="pDest">DOM</div>
        <div class="stk-warn" id="pWarn">FRAGILE</div>
        
        <div class="stk-body">
            <div id="pQr"></div>
            <div class="stk-wb" id="pWb">VG-0000</div>
        </div>

        <div class="stk-addr">
            <b>FROM:</b> <span id="pOrg">...</span><br>
            <b>TO:</b> <span id="pTo">...</span>
        </div>

        <div class="stk-foot">
            <div class="stk-col">
                <div class="stk-lbl">PCS</div>
                <div class="stk-val" id="pQty">1</div>
            </div>
            <div class="stk-col">
                <div class="stk-lbl">KG</div>
                <div class="stk-val" id="pWt">1</div>
            </div>
        </div>
    </div>

    <!-- FIREBASE & LOGIC -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
        import { getFirestore, doc, setDoc, updateDoc, arrayUnion, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";
        import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";

        // CONFIG (VG-CARGO-SYSTEM-3)
        const firebaseConfig = {
            apiKey: "AIzaSyCrDEUr1O5krXFHEB2hafLXuEumEcoSTxM",
            authDomain: "vg-cargo-system-3.firebaseapp.com",
            projectId: "vg-cargo-system-3",
            storageBucket: "vg-cargo-system-3.firebasestorage.app",
            messagingSenderId: "819520192535",
            appId: "1:819520192535:web:8e42b272500f9b60e19c52"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        let html5QrcodeScanner = null;

        // --- AUTHENTICATION ---
        window.login = async () => {
            try { await signInWithEmailAndPassword(auth, document.getElementById('email').value, document.getElementById('pass').value); } 
            catch(e){ alert(e.message); }
        }
        window.logout = () => signOut(auth);
        
        onAuthStateChanged(auth, user => {
            if(user) {
                document.getElementById('viewLogin').classList.add('hidden');
                document.getElementById('viewMain').classList.remove('hidden');
                generateRandomWB();
                loadLocations();
            } else {
                document.getElementById('viewLogin').classList.remove('hidden');
                document.getElementById('viewMain').classList.add('hidden');
            }
        });

        // --- TABS LOGIC ---
        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.add('hidden'));
            document.getElementById('tab-'+tab).classList.remove('hidden');
            
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            // Highlight current tab (Logic simplified for 2 tabs)
            if(tab === 'create') document.querySelector('.nav-item:nth-child(1)').classList.add('active');
            else document.querySelector('.nav-item:nth-child(2)').classList.add('active');

            if(tab === 'scan') startCamera(); else stopCamera();
        }

        // --- CREATE WAYBILL ---
        window.generateRandomWB = () => {
            document.getElementById('wbInput').value = "VG-" + Math.floor(100000 + Math.random() * 900000);
        }

        window.createParcel = async () => {
            const wb = document.getElementById('wbInput').value;
            const org = document.getElementById('shipperAddr').value;
            const des = document.getElementById('consigneeAddr').value;
            const qty = document.getElementById('qty').value;
            const wt = document.getElementById('weight').value;
            const hdl = document.getElementById('handling').value;

            if(!org || !des) return alert("Fill Origin & Destination");

            const btn = document.querySelector('.btn-success');
            btn.innerHTML = "SAVING..."; btn.disabled = true;

            try {
                // Save to Database
                await setDoc(doc(db, "parcels", wb), {
                    waybill: wb,
                    shipper: { name: "Mobile", addr: org, contact: "" },
                    consignee: { name: "Mobile", addr: des, contact: "" },
                    details: { qty: qty, weight: wt, handling: hdl },
                    currentStatus: "Accepted",
                    createdBy: auth.currentUser.email,
                    history: [{ status: "Accepted", location: "Origin (Mobile)", time: new Date().toLocaleString() }]
                });

                // Prepare Sticker for Printing
                prepareSticker(wb, org, des, qty, wt, hdl);

                // Send to RawBT (Wait for image gen)
                setTimeout(() => {
                    html2canvas(document.querySelector("#sticker-canvas")).then(canvas => {
                        const base64 = canvas.toDataURL("image/png").split(',')[1];
                        window.location.href = "rawbt:base64," + base64; // DIRECT PRINT
                    });
                    
                    // Reset Form
                    alert("Saved & Sent to Printer!");
                    document.getElementById('shipperAddr').value = "";
                    document.getElementById('consigneeAddr').value = "";
                    document.getElementById('weight').value = "";
                    generateRandomWB();
                    btn.innerHTML = '<i class="fas fa-save me-2"></i> SAVE & PRINT'; btn.disabled = false;
                }, 500);

            } catch(e) { 
                alert("Error: " + e.message);
                btn.innerHTML = '<i class="fas fa-save me-2"></i> SAVE & PRINT'; btn.disabled = false;
            }
        }

        function prepareSticker(wb, org, des, qty, wt, hdl) {
            let code = "DOM";
            const d = des.toUpperCase();
            if(d.includes("DAVAO")) code="DVO";
            else if(d.includes("MANILA") || d.includes("MNL")) code="MNL";
            else if(d.includes("CEBU")) code="CEB";
            else if(d.includes("ILOILO")) code="ILO";
            else if(d.includes("ROXAS")) code="ROX";
            else if(d.includes("BACOLOD")) code="BCD";
            else if(d.includes("CAGAYAN")) code="CGY";
            else if(d.includes("GENSAN")) code="GES";
            else if(d.includes("BUTUAN")) code="BUT";
            else if(d.includes("ZAMBOANGA")) code="ZAM";

            document.getElementById('pDest').innerText = code;
            document.getElementById('pWarn').style.display = (hdl !== 'Standard') ? 'block' : 'none';
            document.getElementById('pWarn').innerText = hdl;
            document.getElementById('pWb').innerText = wb;
            document.getElementById('pOrg').innerText = org;
            document.getElementById('pTo').innerText = des;
            document.getElementById('pQty').innerText = qty;
            document.getElementById('pWt').innerText = wt;

            document.getElementById('pQr').innerHTML = "";
            new QRCode(document.getElementById('pQr'), { text: wb, width: 120, height: 120 });
        }

        // --- SCANNER LOGIC ---
        function stopCamera() { if(html5QrcodeScanner){ html5QrcodeScanner.clear(); html5QrcodeScanner=null; } }
        function startCamera() {
            stopCamera();
            html5QrcodeScanner = new Html5QrcodeScanner("reader", { fps: 10, qrbox: 250, aspectRatio: 1.0 });
            html5QrcodeScanner.render(onScanSuccess, ()=>{});
        }

        function onScanSuccess(wb) {
            html5QrcodeScanner.clear();
            document.getElementById('reader').classList.add('hidden');
            document.getElementById('scanForm').classList.remove('hidden');
            document.getElementById('detectedWB').innerText = wb;
        }

        window.resetScan = () => {
            document.getElementById('scanForm').classList.add('hidden');
            document.getElementById('reader').classList.remove('hidden');
            document.getElementById('currentLocSelect').value = "";
            startCamera();
        }

        function loadLocations() {
            onSnapshot(doc(db, "settings", "locations"), s => {
                let list = ["MNL HUB", "CEB HUB", "DVO HUB", "Rider", "Delivered"];
                if(s.exists() && s.data().list) list = s.data().list;
                list = [...new Set(list)].sort();
                let opts = list.map(l => `<option value="${l}">${l}</option>`).join('');
                opts += `<option value="Other">+ New Location</option>`;
                document.getElementById('currentLocSelect').innerHTML = `<option disabled selected>Select...</option>` + opts;
            });
        }

        window.toggleCustomLoc = () => {
            const v = document.getElementById('currentLocSelect').value;
            if(v==='Other') document.getElementById('currentLocCustom').classList.remove('hidden');
            else document.getElementById('currentLocCustom').classList.add('hidden');
        }

        window.updateStatus = async () => {
            const wb = document.getElementById('detectedWB').innerText;
            let loc = document.getElementById('currentLocSelect').value;
            let isCustom = false;
            if(loc === 'Other') { loc = document.getElementById('currentLocCustom').value.trim(); isCustom = true; }
            if(!loc) return alert("Select Location");

            let s = "Arrived at Hub";
            if(loc.toUpperCase().includes("RIDER")) s = "Out for Delivery";
            if(loc.toUpperCase() === "DELIVERED") s = "Delivered";

            try {
                await updateDoc(doc(db, "parcels", wb), {
                    currentStatus: s,
                    history: arrayUnion({ status: s, location: loc, time: new Date().toLocaleString(), user: auth.currentUser.email })
                });
                if(isCustom) await setDoc(doc(db, "settings", "locations"), { list: arrayUnion(loc) }, { merge: true });
                
                alert("Updated!"); resetScan();
            } catch(e) { alert(e.message); }
        }
    </script>
</body>
</html>